<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Código de Barras</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        #barcodeInput { padding: 10px; font-size: 1.2em; width: 100%; max-width: 300px; }
        video { max-width: 100%; width: 300px; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Leitor de Código de Barras</h1>
    
    <label for="barcodeInput">Código de Barras:</label>
    <input type="text" id="barcodeInput" placeholder="Clique para ler código de barras" readonly onclick="startCamera()" />
    <br><br>
    <button onclick="startCamera()">Iniciar Leitura</button>

    <video id="video" autoplay playsinline style="display: none;"></video>

    <script>
        let video = document.getElementById('video');
        let barcodeInput = document.getElementById('barcodeInput');
        let streamStarted = false;

        async function startCamera() {
            if (!streamStarted) {
                try {
                    let stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    video.srcObject = stream;
                    video.style.display = 'block';
                    streamStarted = true;
                    decodeBarcode();
                } catch (error) {
                    console.error("Erro ao acessar a câmera:", error);
                    alert("Permissão para acessar a câmera negada ou não disponível.");
                }
            }
        }

        function stopCamera() {
            if (video.srcObject) {
                let tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.style.display = 'none';
                streamStarted = false;
            }
        }

        function decodeBarcode() {
            const barcodeDetector = new BarcodeDetector({ formats: ['ean_13', 'code_128'] });

            function scanFrame() {
                barcodeDetector.detect(video).then(barcodes => {
                    if (barcodes.length > 0) {
                        barcodeInput.value = barcodes[0].rawValue;
                        stopCamera();
                    } else {
                        requestAnimationFrame(scanFrame);
                    }
                }).catch(err => {
                    console.error("Erro ao detectar código de barras:", err);
                });
            }

            scanFrame();
        }
    </script>
</body>
</html>
